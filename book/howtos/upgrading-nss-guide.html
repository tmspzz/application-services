<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>How to upgrade NSS - Cross-platform Rust Components</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../shared/a-s.css">
        <link rel="stylesheet" href="../shared/mermaid.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Application Services Rust Components</a></li><li class="chapter-item expanded "><a href="../contributing.html"><strong aria-hidden="true">1.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../building.html"><strong aria-hidden="true">1.1.</strong> Building</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../howtos/locally-published-components-in-fenix.html"><strong aria-hidden="true">1.1.1.</strong> How to use the local development autopublish flow for Fenix</a></li><li class="chapter-item expanded "><a href="../howtos/locally-published-components-in-ios.html"><strong aria-hidden="true">1.1.2.</strong> How to use the local development flow for Firefox iOS</a></li><li class="chapter-item expanded "><a href="../howtos/locally-published-spm-in-ios.html"><strong aria-hidden="true">1.1.3.</strong> How to use the local development flow for Focus for iOS</a></li><li class="chapter-item expanded "><a href="../howtos/locally-building-jna.html"><strong aria-hidden="true">1.1.4.</strong> How to locally build JNA</a></li></ol></li><li class="chapter-item expanded "><a href="../howtos/testing-a-rust-component.html"><strong aria-hidden="true">1.2.</strong> How to test Rust Components</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../howtos/smoke-testing-app-services.html"><strong aria-hidden="true">1.2.1.</strong> How to integration (smoke) test application-services</a></li><li class="chapter-item expanded "><a href="../design/test-faster.html"><strong aria-hidden="true">1.2.2.</strong> Writing efficient tests</a></li></ol></li><li class="chapter-item expanded "><a href="../dependency-management.html"><strong aria-hidden="true">1.3.</strong> Dependency management</a></li><li class="chapter-item expanded "><a href="../howtos/adding-a-new-component.html"><strong aria-hidden="true">1.4.</strong> How to add a new component</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../howtos/building-a-rust-component.html"><strong aria-hidden="true">1.4.1.</strong> How to build a new syncable component</a></li><li class="chapter-item expanded "><a href="../naming-conventions.html"><strong aria-hidden="true">1.4.2.</strong> Naming Conventions</a></li><li class="chapter-item expanded "><a href="../howtos/converting-a-component-to-uniffi.html"><strong aria-hidden="true">1.4.3.</strong> How to convert a Rust Component to Uniffi</a></li><li class="chapter-item expanded "><a href="../howtos/when-to-use-what-in-the-ffi.html"><strong aria-hidden="true">1.4.4.</strong> How to know what to use when in the FFI</a></li><li class="chapter-item expanded "><a href="../android-faqs.html"><strong aria-hidden="true">1.4.5.</strong> How to use Rust Components in Android</a></li><li class="chapter-item expanded "><a href="../howtos/consuming-rust-components-on-ios.html"><strong aria-hidden="true">1.4.6.</strong> How to use Rust Components on iOS</a></li></ol></li><li class="chapter-item expanded "><a href="../logging.html"><strong aria-hidden="true">1.5.</strong> Logging</a></li></ol></li><li class="chapter-item expanded "><a href="../adr/index.html"><strong aria-hidden="true">2.</strong> Architectural Decision Records</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../adr/0000-use-markdown-architectural-decision-records.html"><strong aria-hidden="true">2.1.</strong> ADR-0000</a></li><li class="chapter-item expanded "><a href="../adr/0001-update-logins-api.html"><strong aria-hidden="true">2.2.</strong> ADR-0001</a></li><li class="chapter-item expanded "><a href="../adr/0002-database-corruption.html"><strong aria-hidden="true">2.3.</strong> ADR-0002</a></li><li class="chapter-item expanded "><a href="../adr/0003-swift-packaging.html"><strong aria-hidden="true">2.4.</strong> ADR-0003</a></li><li class="chapter-item expanded "><a href="../adr/0004-early-startup-experiments.html"><strong aria-hidden="true">2.5.</strong> ADR-0004</a></li></ol></li><li class="chapter-item expanded "><a href="../design/index.html"><strong aria-hidden="true">3.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../design/megazords.html"><strong aria-hidden="true">3.1.</strong> Megazords</a></li><li class="chapter-item expanded "><a href="../design/sync-manager.html"><strong aria-hidden="true">3.2.</strong> Sync Manager</a></li><li class="chapter-item expanded "><a href="../design/sync-overview.html"><strong aria-hidden="true">3.3.</strong> Sync overview</a></li><li class="chapter-item expanded "><a href="../design/swift-package-manager.html"><strong aria-hidden="true">3.4.</strong> Shipping Rust Components as Swift Packages</a></li><li class="chapter-item expanded "><a href="../design/components-strategy.html"><strong aria-hidden="true">3.5.</strong> Rust Component's Strategy</a></li><li class="chapter-item expanded "><a href="../design/metrics.html"><strong aria-hidden="true">3.6.</strong> Metrics - (Glean Telemetry)</a></li><li class="chapter-item expanded "><a href="../design/rust-versions.html"><strong aria-hidden="true">3.7.</strong> Rust Version Policy</a></li></ol></li><li class="chapter-item expanded "><a href="../howtos/cut-a-new-release.html"><strong aria-hidden="true">4.</strong> How to cut a new release</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../build-and-publish-pipeline.html"><strong aria-hidden="true">4.1.</strong> CI Publishing tools and flow</a></li><li class="chapter-item expanded "><a href="../howtos/upgrading-nss-guide.html" class="active"><strong aria-hidden="true">4.2.</strong> How to upgrade NSS</a></li></ol></li><li class="chapter-item expanded "><a href="../rust-docs/fxa_client/index.html"><strong aria-hidden="true">5.</strong> Rustdocs for components</a></li><li class="chapter-item expanded "><a href="../adding-docs.html"><strong aria-hidden="true">6.</strong> Adding to these documents</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cross-platform Rust Components</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/mozilla/application-services" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="guide-to-upgrading-nss"><a class="header" href="#guide-to-upgrading-nss">Guide to upgrading NSS</a></h1>
<p>Our components rely on cryptographic primitives provided by <a href="https://developer.mozilla.org/docs/Mozilla/Projects/NSS">NSS</a>.
Every month or so, a new version of NSS is <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/NSS_Releases">published</a> and we should try to keep our version as up-to-date as possible.</p>
<p>Because it makes unit testing easier on Android, and helps startup performance on iOS, we compile NSS ourselves and link to it statically. Note that NSS is mainly used by Mozilla as a dynamic library and the NSS project is missing related CI jobs (iOS builds, windows cross-compile builds etc.) so you should expect breakage when updating the library (hence this guide).</p>
<h2 id="updating-the-version"><a class="header" href="#updating-the-version">Updating the Version</a></h2>
<p>The build code is located in the <a href="https://github.com/mozilla/application-services/tree/main/libs"><code>libs/</code></a> folder.</p>
<p>The version string is located in the beginning of <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/libs/build-all.sh#L8-L11"><code>build-all.sh</code></a>. For most NSS upgrades, the only action needed is to bump the version number in this file and update the downloaded archive checksum.  The actual build invocations are located in platform-specific script files (e.g. <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/libs/build-nss-ios.sh"><code>build-nss-ios.sh</code></a>) but usually don't require any changes.</p>
<p>Due to the complexity of the NSS build process, we currently use pre-built artifacts
for running tests on MacOS and Win32 desktop machines (ref <a href="https://github.com/mozilla/application-services/issues/962">#962</a>). You can regenerate these artifacts by taking advantage of the <a href="https://wiki.mozilla.org/NSS:TryServer">NSS TryServer</a> infrastructure, with some patches to the NSS source:</p>
<ol>
<li>Get the source for NSS:
<ul>
<li><code>hg clone https://hg.mozilla.org/projects/nss</code></li>
<li><code>cd nss</code></li>
</ul>
</li>
<li>Apply <a href="https://phabricator.services.mozilla.com/D30511">this patch</a> for Windows mingw build support, rebasing it on top
of the release tag for the target NSS version:
<ul>
<li><code>moz-phab patch --apply-to NSS_&lt;X&gt;_&lt;YY&gt;_RTM D30511</code></li>
</ul>
</li>
<li>Do your best to fix up any conflicts that may have resulted from the rebase, sorry :-(
<ul>
<li>The rejected hunks of the patch can be found with <code>find . -name &quot;*.rej&quot;</code>.</li>
<li>You will need to <code>hg commit -A</code> any manual changes before proceeding to the next step.</li>
</ul>
</li>
<li>Apply the patch from <a href="../../libs/build-nss-static-libs.patch">/libs/build-nss-static-libs.patch</a> to make the tryserver build static artifacts.
<ul>
<li><code>hg patch ../application-services/libs/build-nss-static-libs.patch</code></li>
</ul>
</li>
<li>Do your best to fix up any conflicts that may have resulted from an outdated patch, sorry :-(
<ul>
<li>As above, you will need to <code>hg commit -A</code> any manual changes before proceeding to the next step.</li>
</ul>
</li>
<li>Follow <a href="https://wiki.mozilla.org/NSS:TryServer#Pushing_to_nss-try">these instructions</a> to push the resulting
commit to try.
<ul>
<li>Confirm that all your changes have been committed.</li>
<li>Make sure you've added the <code>nss-try</code> path to your <code>.hg/hgrc</code> config.</li>
<li>Update the commit message to limit the number of jobs that are run.
<ul>
<li><code>hg commit --amend --message &quot;try: -b opt -p mac,linux64-mingw-w64 -u none -t none&quot;</code></li>
</ul>
</li>
<li><code>hg push -r . -f nss-try</code></li>
<li>Visit the <a href="https://treeherder.mozilla.org/jobs?repo=nss-try">tryserver dashboard</a> and find the resulting job.
<ul>
<li>If you can't find it, try adding <code>&amp;author=you@mozilla.com</code> to the query string for filtering.</li>
</ul>
</li>
</ul>
</li>
<li>Once the build has completed, find the generated artifacts and download them.
<ul>
<li>
<p>The necessary UI looks like this:
<img src="./img/nss_tryserver_artifacts.png" /></p>
</li>
<li>
<p>For MacOS builds, download from the job named &quot;mac opt&quot;.</p>
</li>
<li>
<p>For Windows builds, download from the job named &quot;linux64-mingw-w64 opt&quot;.</p>
</li>
<li>
<p>Rename the files to <code>nss_nspr_static_&lt;X&gt;.&lt;YY&gt;_&lt;darwin|mingw&gt;.&lt;ext&gt;</code> following the pattern used by existing files.</p>
</li>
</ul>
</li>
<li>Upload the resulting files to S3 at <a href="https://fxa-dev-bucket.s3-us-west-2.amazonaws.com/a-s/">https://fxa-dev-bucket.s3-us-west-2.amazonaws.com/a-s/</a>.
<ul>
<li>You'll need an account in the <a href="https://cloudservices-aws-dev.signin.aws.amazon.com/">Cloud Services AWS Dev Console</a>.
Find out more on the <a href="https://mana.mozilla.org/wiki/display/SVCOPS/AWS">SVCOPS AWS Mana page</a>.</li>
</ul>
</li>
</ol>
<p>Once these files have been uploaded, update the URLs and corresponding checksums in
<a href="https://github.com/mozilla/application-services/blob/bb5ff1b649bddae9bbd9157f4023304c467e388e/libs/build-nss-desktop.sh#L59-L74">build-nss-desktop.sh</a>.</p>
<p>This process is far from optimal; <a href="https://github.com/mozilla/application-services/issues/962">#962</a> tracks the work of further automating these steps.</p>
<p>To test out your changes:</p>
<ul>
<li>Clear any old NSS build artifacts: <code>rm -rf ./libs/desktop &amp;&amp; cargo clean</code></li>
<li>Install the updates version: <code>./libs/verify-desktop-environment.sh</code></li>
<li>Try it out: <code>cargo test</code></li>
</ul>
<h2 id="exposing-new-functions"><a class="header" href="#exposing-new-functions">Exposing new functions</a></h2>
<p>If the new version of NSS comes with new functions that you want to expose, you will need to:</p>
<ul>
<li>Add low-level bindings for those functions in the <a href="../../components/support/rc_crypto/nss/nss_sys"><code>nss_sys</code> crate</a>; follow the instructions in
README for that crate.</li>
<li>Expose a safe wrapper API for the functions from the <a href="../../components/support/rc_crypto/nss"><code>nss</code> crate</a>;</li>
<li>Expose a convenient high-level API for the functions from the <a href="../../components/support/rc_crypto"><code>rc_crypto</code> crate</a>;</li>
</ul>
<h2 id="tips-for-fixing-bustage"><a class="header" href="#tips-for-fixing-bustage">Tips for Fixing Bustage</a></h2>
<p>On top of the primitives provided by NSS, we have built a safe Rust wrapper named <a href="https://github.com/mozilla/application-services/tree/main/components/support/rc_crypto">rc_crypto</a> that links to NSS and makes these cryptographic primitives available to our components.</p>
<p>The linkage is done by the <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/components/support/rc_crypto/nss/nss_build_common/src/lib.rs"><code>nss_build_common</code></a> crate. Note that it supports a <code>is_gecko</code> feature to link to NSS dynamically on Desktop.</p>
<p>Because the NSS static build process does not output a single <code>.a</code> file (it would be great if it did), this file must <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/components/support/rc_crypto/nss/nss_build_common/src/lib.rs#L85-L133">describe</a> for each architecture which modules should we link against. It is mostly a duplication of logic from the <a href="https://searchfox.org/nss/rev/d0ca572a63597a19889611c065273f131cc09b7a/lib/freebl/freebl.gyp#385-408">NSS gyp build files</a>. Note that this logic is also duplicated in our NSS lib build steps (e.g. <a href="https://github.com/mozilla/application-services/blob/b0b3daa6580d04906fc53e9e479e8bebb464cf78/libs/build-nss-desktop.sh#L82-L114">build-nss-desktop.sh</a>).</p>
<p>One of the most common build failures we get when upgrading NSS comes from NSS adding new vectorized/asm versions of a crypto algorithm for a specific architecture in order to improve performance. This new optimized code gets implemented as a new gyp target/module that is emitted only for the supported architectures.
When we upgrade our copy of NSS we notice the linking step failing on CI jobs because of undefined symbols.</p>
<p><a href="https://github.com/mozilla/application-services/pull/2476">This PR</a> shows how we update <code>nss_common_build</code> and the build scripts to accommodate for these new modules. Checking the changelog for any suspect commit relating to hardware acceleration is rumored to help.</p>
<footer id="open-on-gh">Found a bug? <a href="https://github.com/mozilla/application-services/edit/main/docs/howtos/upgrading-nss-guide.md">Edit this file on GitHub.</a></footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../build-and-publish-pipeline.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../rust-docs/fxa_client/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../build-and-publish-pipeline.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../rust-docs/fxa_client/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../shared/tabs.js"></script>
        <script type="text/javascript" src="../shared/mermaid.min.js"></script>
        <script type="text/javascript" src="../shared/mermaid-init.js"></script>


    </body>
</html>
